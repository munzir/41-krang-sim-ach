# 41-krang-sim-ach
Hardware simulation of Krang on DART. Publishes states to and subscribes for inputs from ach channels on hardware. These channels existed primarily for communicating with the drivers on hardware. The simulation can be used instead of hardware drivers via these ach channels.

## Dependencies

- DART
 [Dart Homepage](https://dartsim.github.io)

- config4cpp
 [Source Code Download](http://www.config4star.org/#main-source-code)

 How to add config4cpp to your system (Linux/BSD/OSX)

  1: Download and extract the source code of config4cpp

  2: cd config4cpp

  3: Follow the README.txt in config4cpp/

  4: Run the following commands to add the make'd files into your local system

    sudo cp bin/{config2cpp,config4cpp} /usr/local/bin &&
    sudo cp lib/libconfig4cpp.a /usr/local/lib &&
    sudo cp -r include/config4cpp /usr/local/include &&
    sudo chmod g+rx /usr/local/include/config4cpp &&
    sudo chmod o+rx /usr/local/include/config4cpp

  \*Note: You can just copy paste the above block of commands

- [09-URDF](https://github.gatech.edu/WholeBodyControlAttempt1/09-URDF)
 Install the repository.

- [18-OnlineCoM](https://github.gatech.edu/WholeBodyControlAttempt1/18-OnlineCoM)  Install the repository.

- [37-somatic](https://github.gatech.edu/WholeBodyControlAttempt1/37-somatic)
 Install the repository.

- [42-joystick](https://github.gatech.edu/WholeBodyControlAttempt1/42-joystick)
 Install the repository.

- [43-krang-waist](https://github.gatech.edu/WholeBodyControlAttempt1/43-krang-waist)
 Install the repository.

## Installation

Follow the instructions:

    git clone https://github.gatech.edu/WholeBodyControlAttempt1/41-krang-sim-ach
    cd 41-krang-sim-ach
    mkdir build
    cd build
    cmake ..
    sudo make install

## Uninstall
To remove system files created by the installation of this repo.

    sudo make uninstall

## Usage

In what follows, an alternate to `sudo service <program> start` is to do `sudo /etc/init.d/<program> start`. The former may sometimes not work only because the system has not been restarted after installation of `somatic` and `krang-sim-ach`.

### Start event logger
To use ach, we need to run the bash script in the `/etc/init.d` folder named `somatic`. It creates an events channel and logs the events (using a daemon `slogd`). These events are generated by other daemons/programs (such as our simulation program) communicating on ach. To run the script that starts the logger, do:

      sudo service somatic start

Note: Since this script lives in `/etc/init.d`, it is possible that the logger `slogd` is already running after system reboot. In that case, doing `somatic start` will give an error stating that it is already running. If this is the case, then you can move to the next step without doing anything.

### Create ach channels
To use the simulation along with its interface, you first need to launch the ach channels. This is done by the `krang-sim-interface` program:

    sudo service krang-sim-interface create

### Launch the simulation
Now you are ready to launch the simulation

    sudo krang-sim-ach

When the window is launched, press [Space] to start simulation. Press 'v' to get rid of the annoying lines on the simulation at body contact points. You can press [Esc] to kill the simulation window. If you want only the simulation to run without rendering set the parameter `render` in `/usr/local/share/krang-sim-ach/cfg/dart_params.cfg` to `"false"`. To enable/disable external timestepping, modify the parameter `external_timestepping` in `/usr/local/share/krang-sim-ach/ach_params.cfg`. These changes will only take effect when the simulation is launched again.

### Delete ach channels
To close the ach channels:

    sudo service krang-sim-interface delete

You don't need to delete ach channels every time you re-launch the simulation. They need to be created only once. And then simulation can be killed and re-launched without the need to delete/re-create ach channels.

### Stop event logger
To delete the events channel and stop the logging:

      sudo service somatic stop

## Example program

An example program that can interface with this simulation is found in repo [35-balancing](https://github.gatech.edu/WholeBodyControlAttempt1/35-balancing). This program needs two other programs to run (joystick and krang-waist) in order to do its job. If you have a the physical joystick transceiver plugged in to your system, then you can launch these two programs using the following command. This is assuming that the event logger is already alive:

    sudo service krang-sim-interface start

This will not only launch those programs but also create ach channels if they are not already created.

To kill the programs:

    sudo service krang-sim-interface stop

This will also delete the ach channels that were created. It will not delete the event channel being used for logging (see previous section).
